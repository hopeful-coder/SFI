---
title: "supplemental"
author: "Mitchell Schepps"
date: "6/19/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Demographics

```{r, echo=FALSE, warning = F, cache = T, message=F}
library(dplyr)
library(plyr)
library(ggplot2)
library(kableExtra)

setwd('C:/Users/Mitchell Schepps/Desktop/nena/arrests_pop')
# #Load in new data
pop <- read.csv('UCLAQuarterlyReportMarch2020Population.csv', skip = 1)
arrests <- read.csv('UCLAQuarterlyReportMarch2020Arrests.csv')
# 
# pop <- read.csv('UCLAQuarterlyReportDecember2019Population.csv', skip = 1)
# arrests <- read.csv('UCLAQuarterlyReportDecember2019Arrests.csv')

#Formal quarter dates
dates <- as.Date(c('10-23-2017', '01-01-2018', '04-01-2018', '07-01-2018', '10-01-2018',
                   '01-01-2019', '04-01-2019', '07-01-2019', '10-01-2019',
                   '01-01-2020', '04-01-2020', '07-01-2020', '10-01-2020'), format = '%m-%d-%Y')
#Remove initial date for calculations
dates <- dates[-1]

###############################################################################
#Incorporate new information.
###############################################################################
#Rename columns to match
names(pop)[1] <- 'id'
names(arrests)[1] <- 'id'

#Clean up NCC Data for merging purposes
# ncc1 <- ncc1[,-1]
# ncc2 <- ncc2[,-1]
# ncc1 <- ncc1[1:4,]
# names(ncc1)[1] <- 'id'
# names(ncc2)[1] <- 'id'
# names(ncc1)[5] <- 'ncc_date'
# names(ncc2)[6] <- 'ncc_date'
# ncc <- rbind(ncc1[,c(1,5)], ncc2[,c(1,6)])
# ncc[ncc$id == '749462/169056', 'id'] = '749462'
# ncc[ncc$id == '4852861/4589517', 'id'] = '4852861'
# dup = which(duplicated(ncc$id))
# ncc = ncc[-dup, ]
setwd('C:/Users/Mitchell Schepps/Desktop/nena')
#New ncc
ncc = read.csv('ncc_420.csv', skip = 9)
names(ncc)[1] = 'id'
names(ncc)[8] = 'ncc_date'
ncc = ncc[, c('id', 'ncc_date')]

#Merge population dataset and arrest dataset and ncc dataset
test <- merge(pop, arrests, by = 'id', all.x = T)
test <- merge(test, ncc, by = 'id', all.x = T)
test$ncc_date <- as.Date(test$ncc_date, format = '%m/%d/%Y')

#Format dates properly
test2 <- test
test2$X.5 <- as.Date(test2$X.5, format = '%m/%d/%Y')
test2$X.5 <- test2$X.5 - 1
test2$Intake.Date <- as.Date(test2$Intake.Date, format = '%m/%d/%Y')
test2$Referral.Date <- as.Date(test2$Referral.Date, format = '%m/%d/%Y')
test2$Arrest.Date <- as.Date(test2$Arrest.Date, format = '%m/%d/%Y')

#Sort out cohorts
ash = test2
test2 = test2[test2$X.5 < as.Date('06/01/2019', format = '%m/%d/%Y'),]
#Potential ids to watch out for.
# test2 <- test2[!is.na(test2$Intake.Date), ]
# test2 <- test2[!test2$id == 3239845,]
# test2 <- test2[!test2$id == 4575647,]

#List of unique ids
unique.ids <- unique(test2$id)

#List for arrest matrix
arrest.matrix = data.frame()

#Make a loop which figures out which quarter in the formal dates the clean quarter if any happened in
abbie <- c()
abbie <- data.frame(abbie)
abbie.final <- c()
abbie.final <- data.frame(abbie.final)
for(i in 1:length(unique.ids)){
  #Extract one person's data to analyze at a time.
  words <- test2[test2$id == unique.ids[i], ]
  
  #Clean quarter dates
  words$X.5 <- as.Date(words$X.5, format = '%Y-%m-%d')
  cq.dates <- unique(words$X.5) + 90*c(0:6)
  #Use NCC dates
  if(!is.na(unique(words$ncc_date))){
    ncc_date = unique(c(words$ncc_date))
    min.ncc.quarter = max(which(ncc_date >= cq.dates))
    cq.dates <- cq.dates[1:min.ncc.quarter]
  }
  
  #Begin creating the data file for the unique individual
  abbie <- data.frame(id = unique(words$id),
                      randomization.date = unique(words$X.5),
                      risk.level = unique(words$Risk.Level),
                      race = unique(words$X.4),
                      age = unique(words$X.2),
                      gender = unique(words$X.3),
                      day90  = cq.dates[2],
                      day91  = cq.dates[2] + 1,
                      day180 = cq.dates[3],
                      day181 = cq.dates[3] + 1,
                      day270 = cq.dates[4],
                      day271 = cq.dates[4] + 1,
                      day360 = cq.dates[5],
                      day361 = cq.dates[5] + 1,
                      day450 = cq.dates[6],
                      day451 = cq.dates[6] + 1,
                      day540 = cq.dates[7],
                      day541 = cq.dates[7] + 1,
                      day630 = cq.dates[8]
                      # day540 = cq.dates[6] + 90,
                      # day541 = cq.dates[6] + 91,
                      # day630 = cq.dates[6] + 180
  )
  
  #Fix two specific dates
  #I wish there was a better way.
  x = as.Date('2020-01-01', format = '%Y-%m-%d')
  if(any(cq.dates == x)){
    cq.dates[2] = x + 1
  }
  x = as.Date('2019-01-01', format = '%Y-%m-%d')
  if(cq.dates[1] == x){
    cq.dates[1] = x + 1
  }
  x = as.Date('2018-07-01', format = '%Y-%m-%d')
  if(any(cq.dates == x)){
    cq.dates[2] = x + 1
  }
  x = as.Date('2019-07-01', format = '%Y-%m-%d')
  if(any(cq.dates == x)){
    cq.dates[2] = x + 1
  }
  x = as.Date('2020-04-01', format = '%Y-%m-%d')
  if(any(cq.dates == x)){
    placement = which(cq.dates == x)
    cq.dates[placement] = x + 1
  }
  
  #Begin potential quarter calculation
  quarters_achieved = c()
  cq.dates.df = data.frame()
  for(i in 1:length(cq.dates)){
    cq.dates.df.1 = data.frame(cq.dates = cq.dates[i],
                               quarter  = max(which(cq.dates[i] > dates)))
    cq.dates.df = rbind(cq.dates.df, cq.dates.df.1)
    cq.dates2 = cq.dates
    cq.dates = cq.dates[-1]
    min.q = max(which(cq.dates[i] > dates))
    if(is.na(cq.dates[i+1])){
      cq.dates[i + 1] = cq.dates[i]
    }
    min.q = ifelse(cq.dates[i+1] - cq.dates[i] == 90, min.q, min.q)
    max.q = min(which(cq.dates[i] < dates))
    quarters_achieved = c(quarters_achieved, min.q)
    cq.dates = cq.dates2
  }
  
  if(length(cq.dates) == 1){
    quarters_achieved = 0
  }
  quarters_achieved = quarters_achieved[!is.na(quarters_achieved)]
  
  abbie$cq1 <- ifelse(1 %in% quarters_achieved, sum(quarters_achieved == 1), 0)
  abbie$cq2 <- ifelse(2 %in% quarters_achieved, sum(quarters_achieved == 2), 0)
  abbie$cq3 <- ifelse(3 %in% quarters_achieved, sum(quarters_achieved == 3), 0)
  abbie$cq4 <- ifelse(4 %in% quarters_achieved, sum(quarters_achieved == 4), 0)
  abbie$cq5 <- ifelse(5 %in% quarters_achieved, sum(quarters_achieved == 5), 0)
  abbie$cq6 <- ifelse(6 %in% quarters_achieved, sum(quarters_achieved == 6), 0)
  abbie$cq7 <- ifelse(7 %in% quarters_achieved, sum(quarters_achieved == 7), 0)
  abbie$cq8 <- ifelse(8 %in% quarters_achieved, sum(quarters_achieved == 8), 0)
  abbie$cq9 <- ifelse(9 %in% quarters_achieved, sum(quarters_achieved == 9), 0)
  
  #Strict arrest days array for making abbie
  abbie$num.arrests = 0
  arrests.abbie <- c(words$Arrest.Date)
  arrests.type <- words$Offense.Level
  if(!is.na(arrests.abbie)){
    abbie$num.arrests = length(arrests.abbie)
    if(length(arrests.abbie) == 1){
      abbie$arrest1 <- arrests.abbie
      abbie$arrest1type <- arrests.type
    } else if(length(arrests.abbie) == 2){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
    } else if(length(arrests.abbie) == 3){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
    } else if(length(arrests.abbie) == 4){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
    } else if(length(arrests.abbie) == 5){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest4type <- arrests.type[5]
    } else if(length(arrests.abbie) == 6){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest6 <- arrests.abbie[6]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest5type <- arrests.type[5]
      abbie$arrest6type <- arrests.type[6]
    } else if(length(arrests.abbie) == 7){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest6 <- arrests.abbie[6]
      abbie$arrest7 <- arrests.abbie[7]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest5type <- arrests.type[5]
      abbie$arrest6type <- arrests.type[6]
      abbie$arrest7type <- arrests.type[7]
    } else if(length(arrests.abbie) == 8){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest6 <- arrests.abbie[6]
      abbie$arrest7 <- arrests.abbie[7]
      abbie$arrest8 <- arrests.abbie[8]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest5type <- arrests.type[5]
      abbie$arrest6type <- arrests.type[6]
      abbie$arrest7type <- arrests.type[7]
      abbie$arrest8type <- arrests.type[8]
    } else if(length(arrests.abbie) == 9){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest6 <- arrests.abbie[6]
      abbie$arrest7 <- arrests.abbie[7]
      abbie$arrest8 <- arrests.abbie[8]
      abbie$arrest9 <- arrests.abbie[9]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest5type <- arrests.type[5]
      abbie$arrest6type <- arrests.type[6]
      abbie$arrest7type <- arrests.type[7]
      abbie$arrest8type <- arrests.type[8]
      abbie$arrest9type <- arrests.type[9]
    } else if(length(arrests.abbie) == 10){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest6 <- arrests.abbie[6]
      abbie$arrest7 <- arrests.abbie[7]
      abbie$arrest8 <- arrests.abbie[8]
      abbie$arrest9 <- arrests.abbie[9]
      abbie$arrest10 <- arrests.abbie[10]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest5type <- arrests.type[5]
      abbie$arrest6type <- arrests.type[6]
      abbie$arrest7type <- arrests.type[7]
      abbie$arrest8type <- arrests.type[8]
      abbie$arrest9type <- arrests.type[9]
      abbie$arrest10type <- arrests.type[10]
    } else if(length(arrests.abbie) == 11){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest6 <- arrests.abbie[6]
      abbie$arrest7 <- arrests.abbie[7]
      abbie$arrest8 <- arrests.abbie[8]
      abbie$arrest9 <- arrests.abbie[9]
      abbie$arrest10 <- arrests.abbie[10]
      abbie$arrest11 <- arrests.abbie[11]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest5type <- arrests.type[5]
      abbie$arrest6type <- arrests.type[6]
      abbie$arrest7type <- arrests.type[7]
      abbie$arrest8type <- arrests.type[8]
      abbie$arrest9type <- arrests.type[9]
      abbie$arrest10type <- arrests.type[10]
      abbie$arrest11type <- arrests.type[11]
    } else if(length(arrests.abbie) == 12){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest6 <- arrests.abbie[6]
      abbie$arrest7 <- arrests.abbie[7]
      abbie$arrest8 <- arrests.abbie[8]
      abbie$arrest9 <- arrests.abbie[9]
      abbie$arrest10 <- arrests.abbie[10]
      abbie$arrest11 <- arrests.abbie[11]
      abbie$arrest12 <- arrests.abbie[12]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest5type <- arrests.type[5]
      abbie$arrest6type <- arrests.type[6]
      abbie$arrest7type <- arrests.type[7]
      abbie$arrest8type <- arrests.type[8]
      abbie$arrest9type <- arrests.type[9]
      abbie$arrest10type <- arrests.type[10]
      abbie$arrest11type <- arrests.type[11]
      abbie$arrest12type <- arrests.type[12]
    }else if(length(arrests.abbie) == 13){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest6 <- arrests.abbie[6]
      abbie$arrest7 <- arrests.abbie[7]
      abbie$arrest8 <- arrests.abbie[8]
      abbie$arrest9 <- arrests.abbie[9]
      abbie$arrest10 <- arrests.abbie[10]
      abbie$arrest11 <- arrests.abbie[11]
      abbie$arrest12 <- arrests.abbie[12]
      abbie$arrest13 <- arrests.abbie[13]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest5type <- arrests.type[5]
      abbie$arrest6type <- arrests.type[6]
      abbie$arrest7type <- arrests.type[7]
      abbie$arrest8type <- arrests.type[8]
      abbie$arrest9type <- arrests.type[9]
      abbie$arrest10type <- arrests.type[10]
      abbie$arrest11type <- arrests.type[11]
      abbie$arrest12type <- arrests.type[12]
      abbie$arrest13type <- arrests.type[13]
    }
    else if(length(arrests.abbie) == 14){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest6 <- arrests.abbie[6]
      abbie$arrest7 <- arrests.abbie[7]
      abbie$arrest8 <- arrests.abbie[8]
      abbie$arrest9 <- arrests.abbie[9]
      abbie$arrest10 <- arrests.abbie[10]
      abbie$arrest11 <- arrests.abbie[11]
      abbie$arrest12 <- arrests.abbie[12]
      abbie$arrest13 <- arrests.abbie[13]
      abbie$arrest14 <- arrests.abbie[14]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest5type <- arrests.type[5]
      abbie$arrest6type <- arrests.type[6]
      abbie$arrest7type <- arrests.type[7]
      abbie$arrest8type <- arrests.type[8]
      abbie$arrest9type <- arrests.type[9]
      abbie$arrest10type <- arrests.type[10]
      abbie$arrest11type <- arrests.type[11]
      abbie$arrest12type <- arrests.type[12]
      abbie$arrest13type <- arrests.type[13]
      abbie$arrest14type <- arrests.type[14]
    }
  }
  
  #Ever arrested indicator variable
  abbie$ever.arrested <- ifelse(any(is.na(arrests.abbie)), 0, 1)
  
  
  #Which quarter were you arrested in calculation
  arrests = c(words$Arrest.Date)
  arrest.quarter.list = c()
  cq.dates = cq.dates2
  if(is.na(arrests[1])){
    quarters_achieved = quarters_achieved
  } else{
    for(j in 1:length(arrests)){
      arrest.quarter.min = max(which(arrests[j] > cq.dates))
      arrest.quarter.min = cq.dates.df[arrest.quarter.min + 1, 2]
      arrest.quarter.max = min(which(arrests[j] <  cq.dates)) - 1
      arrest.quarter.list = c(arrest.quarter.list, arrest.quarter.min)
    }
  }
  
  #Arrest matrix
  arrest.inter = data.frame(id = unique(words$id))
  arrest.inter$one = sum(arrest.quarter.list == 1)
  arrest.inter$two = sum(arrest.quarter.list == 2)
  arrest.inter$thr = sum(arrest.quarter.list == 3)
  arrest.inter$fou = sum(arrest.quarter.list == 4)
  arrest.inter$fiv = sum(arrest.quarter.list == 5)
  arrest.inter$six = sum(arrest.quarter.list == 6)
  arrest.inter$sev = sum(arrest.quarter.list == 7)
  arrest.inter$eig = sum(arrest.quarter.list == 8)
  arrest.inter$nin = sum(arrest.quarter.list == 9)
  
  arrest.matrix = rbind(arrest.matrix, arrest.inter)
  #Not sure if this will fix the issue where 2 potential quarters, but both were arrested in.
  duplicated_quarters = quarters_achieved[which(duplicated(quarters_achieved) & quarters_achieved %in% arrest.quarter.list)]
  quarters_achieved = quarters_achieved[!(quarters_achieved %in% arrest.quarter.list)]
  quarters_achieved = c(quarters_achieved, duplicated_quarters)
  
  abbie$pq1 <- ifelse(1 %in% quarters_achieved, sum(quarters_achieved == 1), 0)
  abbie$pq2 <- ifelse(2 %in% quarters_achieved, sum(quarters_achieved == 2), 0)
  abbie$pq3 <- ifelse(3 %in% quarters_achieved, sum(quarters_achieved == 3), 0)
  abbie$pq4 <- ifelse(4 %in% quarters_achieved, sum(quarters_achieved == 4), 0)
  abbie$pq5 <- ifelse(5 %in% quarters_achieved, sum(quarters_achieved == 5), 0)
  abbie$pq6 <- ifelse(6 %in% quarters_achieved, sum(quarters_achieved == 6), 0)
  abbie$pq7 <- ifelse(7 %in% quarters_achieved, sum(quarters_achieved == 7), 0)
  abbie$pq8 <- ifelse(8 %in% quarters_achieved, sum(quarters_achieved == 8), 0)
  abbie$pq9 <- ifelse(9 %in% quarters_achieved, sum(quarters_achieved == 9), 0)
  
  
  abbie[abbie$id == 3334613, 'cq5'] = 0
  abbie[abbie$id == 3334613, 'cq6'] = 1
  
  abbie$jan_march18 <- ifelse(abbie$cq1 != 0 & abbie$pq1 != 0, abbie$pq1,
                              ifelse(abbie$cq1 != 0 & abbie$pq1 == 0, 0, NA))
  abbie$apr_june18  <- ifelse(abbie$cq2 != 0 & abbie$pq2 != 0, abbie$pq2,
                              ifelse(abbie$cq2 != 0 & abbie$pq2 == 0, 0, NA))
  abbie$july_sep18  <- ifelse(abbie$cq3 != 0 & abbie$pq3 != 0, abbie$pq3,
                              ifelse(abbie$cq3 != 0 & abbie$pq3 == 0, 0, NA))
  abbie$oct_dec18   <- ifelse(abbie$cq4 != 0 & abbie$pq4 != 0, abbie$pq4,
                              ifelse(abbie$cq4 != 0 & abbie$pq4 == 0, 0, NA))
  abbie$jan_march19 <- ifelse(abbie$cq5 != 0 & abbie$pq5 != 0, abbie$pq5,
                              ifelse(abbie$cq5 != 0 & abbie$pq5 == 0, 0, NA))
  abbie$apr_june19 <- ifelse(abbie$cq6 != 0 & abbie$pq6 != 0, abbie$pq6,
                             ifelse(abbie$cq6 != 0 & abbie$pq6 == 0, 0, NA))
  abbie$july_sep19 <- ifelse(abbie$cq7 != 0 & abbie$pq7 != 0, abbie$pq7,
                             ifelse(abbie$cq7 != 0 & abbie$pq7 == 0, 0, NA))
  abbie$oct_dec19 <- ifelse(abbie$cq8 != 0 & abbie$pq8 != 0, abbie$pq8,
                            ifelse(abbie$cq8 != 0 & abbie$pq8 == 0, 0, NA))
  abbie$jan_mar20 <- ifelse(abbie$cq9 != 0 & abbie$pq9 != 0, abbie$pq9,
                            ifelse(abbie$cq9 != 0 & abbie$pq9 == 0, 0, NA))

  ncc_date = unique(words$ncc_date)
  abbie$ncc = ncc_date
  abbie.final <- rbind.fill(abbie.final, abbie)
  
}

abbie.final2 <- merge(abbie.final, pop[, c('id', 'X.6', 'Intake.Date')], by = 'id')
indice = which(names(abbie.final2) == 'X.6')
names(abbie.final2)[indice] = 'RandomGroup'
# write.csv(abbie.final, 'ucla_arrest_data_190127.csv', row.names = F)


pfs <- abbie.final2[abbie.final2$RandomGroup == 'Pay for Success',]               
pas <- abbie.final2[abbie.final2$RandomGroup == 'Probation as Usual', ]               

pfs <- pfs[!(pfs$Intake.Date == ' '), ]
pfs <- (pfs[as.Date(pfs$Intake.Date, format = '%m/%d/%Y') <= as.Date('03/31/2020', format = '%m/%d/%Y'),])

pfs_pop = colSums(pfs[,c(20:28)])
pfs_clean = colSums(pfs[,c(31:39)])
pfs_a = pfs_pop - pfs_clean
pfs_a <- data.frame(index = c(1:9),
                    arrests = pfs_a)
pfs_pop = data.frame(index = c(1:9),
                  pop = pfs_pop)

other <- pas              
# other <- other[!(other$Intake.Date == ' '), ]
# other <- (other[as.Date(other$Intake.Date, format = '%m/%d/%Y') <= as.Date('03/31/2020', format = '%m/%d/%Y'),])
other_pop = colSums(other[,c(20:28)])
other_clean = colSums(other[,c(31:39)])
other_a = other_pop - other_clean
other_a <- data.frame(index = c(1:9),
                    arrests = other_a)
other_pop = data.frame(index = c(1:9),
                     pop = other_pop)

npfs = dim(pfs)[1]
nother = dim(other)[1]
pfs_age = paste0(round(mean(pfs$age), 1), ' (', round(sd(pfs$age), 1), ')')
other_age = paste0(round(mean(other$age), 1), ' (', round(sd(other$age), 1), ')')
pfs_black = table(pfs$race)[1]
pfs_race = data.frame(table(pfs$race))
pfs_gender = data.frame(table(pfs$gender))
pfs_risk.level = data.frame(table(pfs$risk.level))

other_race = data.frame(table(other$race))
other_gender = data.frame(table(other$gender))
other_risk.level = data.frame(table(other$risk.level))

pfs_race[,1] = as.character(pfs_race[,1])
pfs_race[2,1] = 'Other'
pfs_race[2,2] = '5'
pfs_race = pfs_race[1:4,]

other_race[,1] = as.character(other_race[,1])
other_race[2,1] = 'Other'
other_race[2,2] = '8'
other_race = other_race[1:4,]

M <- as.table(rbind(as.numeric(pfs_race[,2]), as.numeric(other_race[,2])))
race_p = chisq.test(M)$p.value

gender_p = prop.test(c(pfs_gender[2,2], other_gender[2,2]), c(sum(pfs_gender[,2]), sum(other_gender[,2])))$p.value

age_p = t.test(pfs$age, other$age)$p.value

M <- as.table(rbind(as.numeric(pfs_risk.level[,2]), as.numeric(other_risk.level[,2])))
risk_p = chisq.test(M)$p.value

demo_df = data.frame(variable = c('n', 'Age, Mean (SD)', 'Female/Male', 'Race', 'White', 'Hispanic', 'Black', 'Other', 'ORAS Risk Level', 'Low', 'Low/Moderate', 'Moderate', 'High', 'Very High'),
                     pfs = c(npfs, pfs_age, paste(pfs_gender[1,2], pfs_gender[2,2], sep = '/'), '', pfs_race[3,2], pfs_race[4,2], pfs_race[1,2], pfs_race[2,2], '', pfs_risk.level[3,2], pfs_risk.level[4,2], pfs_risk.level[5,2],
                             pfs_risk.level[2,2], pfs_risk.level[6,2]),
                     other = c(nother, other_age, paste(other_gender[1,2], other_gender[2,2], sep = '/'), '', other_race[3,2], other_race[4,2], other_race[1,2], other_race[2,2], '', other_risk.level[3,2], other_risk.level[4,2], other_risk.level[5,2],
                             other_risk.level[2,2], other_risk.level[6,2]),
                     pval = c('-', round(age_p, 4), round(gender_p, 4), round(race_p, 4), '-', '-', '-', '-', round(risk_p, 4),  '-', '-', '-', '-', '-'))
kable(demo_df)
```


## Criminal Justice History
```{r, echo=FALSE, warning = F, cache = T, message=F}

# ggplot() + geom_line(aes(x = index, y = arrests), data = pfs_a) + geom_line(aes(x = index, y = pop), data = pfs_pop)

ggplot() + geom_line(aes(x = index, y = arrests), data = other_a, linetype = 2) + geom_line(aes(x = index, y = pop), data = other_pop, linetype = 2)+ geom_line(aes(x = index, y = arrests), data = pfs_a) + geom_line(aes(x = index, y = pop), data = pfs_pop)
```
## Broken down by risk factors

## Differences within service members between those arrested and not

## Services Received

## Summary

## Cohort 2 Preview

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
