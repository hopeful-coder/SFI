---
title: "VCPA Supplemental Analysis - Skin and Bones Draft"
author: "Mitchell Schepps"
date: "6/19/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Table of Contents (Pages not aligned yet)

\begin{enumerate}
  \item VCPA Rehabilitation Program Description
  \item Data Collection with graphic
  \item Statistical Analysis description
  \begin{itemize}
    \item t-tests and chi-squared tests
    \item p-value explanation and multiple hypothesis testing
  \end{itemize}
  \item Demographics analysis by group
  \item Arrest information by group
  \item Stratification
  \begin{itemize}
    \item Gender Arrest Analysis
    \item Race Arrest Analysis
    \item ORAS Risk Level Arrest Analysis
  \end{itemize}
  \item Supplemental Analysis Description
  \item Supplemental Comparison (Those arrested vs never arrested)
  \item COVID-19 Analysis
  \item Summary
  \item Discussion
  \item Cohort 2 Preview
\end{enumerate}


```{r echo=FALSE, message=FALSE, warning=FALSE, cache=T}
library(dplyr)
library(plyr)
library(ggplot2)
library(kableExtra)

setwd('C:/Users/Mitchell Schepps/Desktop/nena/arrests_pop')
# #Load in new data
pop <- read.csv('UCLAQuarterlyReportMarch2020Population.csv', skip = 1)
arrests <- read.csv('UCLAQuarterlyReportMarch2020Arrests.csv')
# 
# pop <- read.csv('UCLAQuarterlyReportDecember2019Population.csv', skip = 1)
# arrests <- read.csv('UCLAQuarterlyReportDecember2019Arrests.csv')

#Formal quarter dates
dates <- as.Date(c('10-23-2017', '01-01-2018', '04-01-2018', '07-01-2018', '10-01-2018',
                   '01-01-2019', '04-01-2019', '07-01-2019', '10-01-2019',
                   '01-01-2020', '04-01-2020', '07-01-2020', '10-01-2020'), format = '%m-%d-%Y')
#Remove initial date for calculations
dates <- dates[-1]


###############################################################################
#Incorporate new information.
###############################################################################
#Rename columns to match
names(pop)[1] <- 'id'
names(arrests)[1] <- 'id'

#Clean up NCC Data for merging purposes
# ncc1 <- ncc1[,-1]
# ncc2 <- ncc2[,-1]
# ncc1 <- ncc1[1:4,]
# names(ncc1)[1] <- 'id'
# names(ncc2)[1] <- 'id'
# names(ncc1)[5] <- 'ncc_date'
# names(ncc2)[6] <- 'ncc_date'
# ncc <- rbind(ncc1[,c(1,5)], ncc2[,c(1,6)])
# ncc[ncc$id == '749462/169056', 'id'] = '749462'
# ncc[ncc$id == '4852861/4589517', 'id'] = '4852861'
# dup = which(duplicated(ncc$id))
# ncc = ncc[-dup, ]
setwd('C:/Users/Mitchell Schepps/Desktop/nena')
#New ncc
ncc = read.csv('ncc_420.csv', skip = 9)
names(ncc)[1] = 'id'
names(ncc)[8] = 'ncc_date'
ncc = ncc[, c('id', 'ncc_date')]

#Merge population dataset and arrest dataset and ncc dataset
test <- merge(pop, arrests, by = 'id', all.x = T)
test <- merge(test, ncc, by = 'id', all.x = T)
test$ncc_date <- as.Date(test$ncc_date, format = '%m/%d/%Y')

#Format dates properly
test2 <- test
test2$X.5 <- as.Date(test2$X.5, format = '%m/%d/%Y')
test2$X.5 <- test2$X.5 - 1
test2$Intake.Date <- as.Date(test2$Intake.Date, format = '%m/%d/%Y')
test2$Referral.Date <- as.Date(test2$Referral.Date, format = '%m/%d/%Y')
test2$Arrest.Date <- as.Date(test2$Arrest.Date, format = '%m/%d/%Y')

#Sort out cohorts
ash = test2
test2 = test2[test2$X.5 < as.Date('06/01/2019', format = '%m/%d/%Y'),]
#Potential ids to watch out for.
# test2 <- test2[!is.na(test2$Intake.Date), ]
# test2 <- test2[!test2$id == 3239845,]
# test2 <- test2[!test2$id == 4575647,]

#List of unique ids
unique.ids <- unique(test2$id)
arrest.matrix = data.frame()

  #Make a loop which figures out which quarter in the formal dates the clean quarter if any happened in
abbie <- c()
abbie <- data.frame(abbie)
abbie.final <- c()
abbie.final <- data.frame(abbie.final)
for(i in 1:length(unique.ids)){
  #Extract one person's data to analyze at a time.
  words <- test2[test2$id == unique.ids[i], ]
  
  #Clean quarter dates
  words$X.5 <- as.Date(words$X.5, format = '%Y-%m-%d')
  cq.dates <- unique(words$X.5) + 90*c(0:6)
  #Use NCC dates
  if(!is.na(unique(words$ncc_date))){
    ncc_date = unique(c(words$ncc_date))
    min.ncc.quarter = max(which(ncc_date >= cq.dates))
    cq.dates <- cq.dates[1:min.ncc.quarter]
  }
  
  #Begin creating the data file for the unique individual
  abbie <- data.frame(id = unique(words$id),
                      randomization.date = unique(words$X.5),
                      risk.level = unique(words$Risk.Level),
                      race = unique(words$X.4),
                      age = unique(words$X.2),
                      gender = unique(words$X.3),
                      day90  = cq.dates[2],
                      day91  = cq.dates[2] + 1,
                      day180 = cq.dates[3],
                      day181 = cq.dates[3] + 1,
                      day270 = cq.dates[4],
                      day271 = cq.dates[4] + 1,
                      day360 = cq.dates[5],
                      day361 = cq.dates[5] + 1,
                      day450 = cq.dates[6],
                      day451 = cq.dates[6] + 1,
                      day540 = cq.dates[7],
                      day541 = cq.dates[7] + 1,
                      day630 = cq.dates[8]
                      # day540 = cq.dates[6] + 90,
                      # day541 = cq.dates[6] + 91,
                      # day630 = cq.dates[6] + 180
  )
  
  #Fix two specific dates
  #I wish there was a better way.
  x = as.Date('2020-01-01', format = '%Y-%m-%d')
  if(any(cq.dates == x)){
    cq.dates[2] = x + 1
  }
  x = as.Date('2019-01-01', format = '%Y-%m-%d')
  if(cq.dates[1] == x){
    cq.dates[1] = x + 1
  }
  x = as.Date('2018-07-01', format = '%Y-%m-%d')
  if(any(cq.dates == x)){
    cq.dates[2] = x + 1
  }
  x = as.Date('2019-07-01', format = '%Y-%m-%d')
  if(any(cq.dates == x)){
    cq.dates[2] = x + 1
  }
  x = as.Date('2020-04-01', format = '%Y-%m-%d')
  if(any(cq.dates == x)){
    placement = which(cq.dates == x)
    cq.dates[placement] = x + 1
  }
  
  #Begin potential quarter calculation
  quarters_achieved = c()
  cq.dates.df = data.frame()
  for(i in 1:length(cq.dates)){
    cq.dates.df.1 = data.frame(cq.dates = cq.dates[i],
                               quarter  = max(which(cq.dates[i] > dates)))
    cq.dates.df = rbind(cq.dates.df, cq.dates.df.1)
    cq.dates2 = cq.dates
    cq.dates = cq.dates[-1]
    min.q = max(which(cq.dates[i] > dates))
    if(is.na(cq.dates[i+1])){
      cq.dates[i + 1] = cq.dates[i]
    }
    min.q = ifelse(cq.dates[i+1] - cq.dates[i] == 90, min.q, min.q)
    max.q = min(which(cq.dates[i] < dates))
    quarters_achieved = c(quarters_achieved, min.q)
    cq.dates = cq.dates2
  }
  
  
  
  if(length(cq.dates) == 1){
    quarters_achieved = 0
  }
  quarters_achieved = quarters_achieved[!is.na(quarters_achieved)]
  
  abbie$cq1 <- ifelse(1 %in% quarters_achieved, sum(quarters_achieved == 1), 0)
  abbie$cq2 <- ifelse(2 %in% quarters_achieved, sum(quarters_achieved == 2), 0)
  abbie$cq3 <- ifelse(3 %in% quarters_achieved, sum(quarters_achieved == 3), 0)
  abbie$cq4 <- ifelse(4 %in% quarters_achieved, sum(quarters_achieved == 4), 0)
  abbie$cq5 <- ifelse(5 %in% quarters_achieved, sum(quarters_achieved == 5), 0)
  abbie$cq6 <- ifelse(6 %in% quarters_achieved, sum(quarters_achieved == 6), 0)
  abbie$cq7 <- ifelse(7 %in% quarters_achieved, sum(quarters_achieved == 7), 0)
  abbie$cq8 <- ifelse(8 %in% quarters_achieved, sum(quarters_achieved == 8), 0)
  abbie$cq9 <- ifelse(9 %in% quarters_achieved, sum(quarters_achieved == 9), 0)
  
  

  abbie$num.arrests = 0
  arrests.abbie <- c(words$Arrest.Date)
  arrests.type <- words$Offense.Level
  if(!is.na(arrests.abbie)){
    arrest_quarters = c()
    arrest.dates.df = data.frame()
      arrest.dates = c(words$Arrest.Date)
      for(i in 1:length(arrest.dates)){
        arrest.dates = sort(arrest.dates)
        arrest.dates.df.1 = data.frame(arrest.dates = arrest.dates[i],
                               quarter  = max(which(arrest.dates[i] > dates)))
        arrest.dates.df = rbind(arrest.dates.df, arrest.dates.df.1)
        arrest.dates2 = arrest.dates
        min.q = max(which(arrest.dates[i] > dates))
        if(is.na(arrest.dates[i+1])){
          arrest.dates[i + 1] = arrest.dates[i]
    }
    min.q = ifelse(arrest.dates[i+1] - arrest.dates[i] == 90, min.q, min.q)
    max.q = min(which(arrest.dates[i] < dates))
    arrest_quarters= c(arrest_quarters, min.q)
    arrest.dates = arrest.dates2
      }
    
    abbie$num.arrests = length(arrests.abbie)
    abbie$num.arrests1 = sum(arrest_quarters == 1, na.rm = T)
    abbie$num.arrests2 = sum(arrest_quarters == 2, na.rm = T)
    abbie$num.arrests3 = sum(arrest_quarters == 3, na.rm = T)
    abbie$num.arrests4 = sum(arrest_quarters == 4, na.rm = T)
    abbie$num.arrests5 = sum(arrest_quarters == 5, na.rm = T)
    abbie$num.arrests6 = sum(arrest_quarters == 6, na.rm = T)
    abbie$num.arrests7 = sum(arrest_quarters == 7, na.rm = T)
    abbie$num.arrests8 = sum(arrest_quarters == 8, na.rm = T)
    abbie$num.arrests9 = sum(arrest_quarters == 9, na.rm = T)
    
    arrests.abbie = sort(arrests.abbie)
    if(length(arrests.abbie) == 1){
      abbie$arrest1 <- arrests.abbie
      abbie$arrest1type <- arrests.type
      abbie$aq1 = arrest_quarters[1]
    } else if(length(arrests.abbie) == 2){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$aq1 = arrest_quarters[1]
      abbie$aq2 = arrest_quarters[2]
    } else if(length(arrests.abbie) == 3){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$aq1 = arrest_quarters[1]
      abbie$aq2 = arrest_quarters[2]
      abbie$aq3 = arrest_quarters[3]
    } else if(length(arrests.abbie) == 4){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$aq1 = arrest_quarters[1]
      abbie$aq2 = arrest_quarters[2]
      abbie$aq3 = arrest_quarters[3]
      abbie$aq4 = arrest_quarters[4]
    } else if(length(arrests.abbie) == 5){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest4type <- arrests.type[5]
      abbie$aq1 = arrest_quarters[1]
      abbie$aq2 = arrest_quarters[2]
      abbie$aq3 = arrest_quarters[3]
      abbie$aq4 = arrest_quarters[4]
      abbie$aq5 = arrest_quarters[5]
    } else if(length(arrests.abbie) == 6){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest6 <- arrests.abbie[6]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest5type <- arrests.type[5]
      abbie$arrest6type <- arrests.type[6]
      abbie$aq1 = arrest_quarters[1]
      abbie$aq2 = arrest_quarters[2]
      abbie$aq3 = arrest_quarters[3]
      abbie$aq4 = arrest_quarters[4]
      abbie$aq5 = arrest_quarters[5]
      abbie$aq6 = arrest_quarters[6]
    } else if(length(arrests.abbie) == 7){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest6 <- arrests.abbie[6]
      abbie$arrest7 <- arrests.abbie[7]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest5type <- arrests.type[5]
      abbie$arrest6type <- arrests.type[6]
      abbie$arrest7type <- arrests.type[7]
      abbie$aq1 = arrest_quarters[1]
      abbie$aq2 = arrest_quarters[2]
      abbie$aq3 = arrest_quarters[3]
      abbie$aq4 = arrest_quarters[4]
      abbie$aq5 = arrest_quarters[5]
      abbie$aq6 = arrest_quarters[6]
      abbie$aq7 = arrest_quarters[7]
    } else if(length(arrests.abbie) == 8){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest6 <- arrests.abbie[6]
      abbie$arrest7 <- arrests.abbie[7]
      abbie$arrest8 <- arrests.abbie[8]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest5type <- arrests.type[5]
      abbie$arrest6type <- arrests.type[6]
      abbie$arrest7type <- arrests.type[7]
      abbie$arrest8type <- arrests.type[8]
      abbie$aq1 = arrest_quarters[1]
      abbie$aq2 = arrest_quarters[2]
      abbie$aq3 = arrest_quarters[3]
      abbie$aq4 = arrest_quarters[4]
      abbie$aq5 = arrest_quarters[5]
      abbie$aq6 = arrest_quarters[6]
      abbie$aq7 = arrest_quarters[7]
      abbie$aq8 = arrest_quarters[8]
      abbie$aq9 = arrest_quarters[9]
    } else if(length(arrests.abbie) == 9){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest6 <- arrests.abbie[6]
      abbie$arrest7 <- arrests.abbie[7]
      abbie$arrest8 <- arrests.abbie[8]
      abbie$arrest9 <- arrests.abbie[9]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest5type <- arrests.type[5]
      abbie$arrest6type <- arrests.type[6]
      abbie$arrest7type <- arrests.type[7]
      abbie$arrest8type <- arrests.type[8]
      abbie$arrest9type <- arrests.type[9]
      abbie$aq1 = arrest_quarters[1]
      abbie$aq2 = arrest_quarters[2]
      abbie$aq3 = arrest_quarters[3]
      abbie$aq4 = arrest_quarters[4]
      abbie$aq5 = arrest_quarters[5]
      abbie$aq6 = arrest_quarters[6]
      abbie$aq7 = arrest_quarters[7]
      abbie$aq8 = arrest_quarters[8]
      abbie$aq9 = arrest_quarters[9]
    } else if(length(arrests.abbie) == 10){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest6 <- arrests.abbie[6]
      abbie$arrest7 <- arrests.abbie[7]
      abbie$arrest8 <- arrests.abbie[8]
      abbie$arrest9 <- arrests.abbie[9]
      abbie$arrest10 <- arrests.abbie[10]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest5type <- arrests.type[5]
      abbie$arrest6type <- arrests.type[6]
      abbie$arrest7type <- arrests.type[7]
      abbie$arrest8type <- arrests.type[8]
      abbie$arrest9type <- arrests.type[9]
      abbie$arrest10type <- arrests.type[10]
      abbie$aq1 = arrest_quarters[1]
      abbie$aq2 = arrest_quarters[2]
      abbie$aq3 = arrest_quarters[3]
      abbie$aq4 = arrest_quarters[4]
      abbie$aq5 = arrest_quarters[5]
      abbie$aq6 = arrest_quarters[6]
      abbie$aq7 = arrest_quarters[7]
      abbie$aq8 = arrest_quarters[8]
      abbie$aq9 = arrest_quarters[9]
      abbie$aq10 = arrest_quarters[10]
    } else if(length(arrests.abbie) == 11){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest6 <- arrests.abbie[6]
      abbie$arrest7 <- arrests.abbie[7]
      abbie$arrest8 <- arrests.abbie[8]
      abbie$arrest9 <- arrests.abbie[9]
      abbie$arrest10 <- arrests.abbie[10]
      abbie$arrest11 <- arrests.abbie[11]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest5type <- arrests.type[5]
      abbie$arrest6type <- arrests.type[6]
      abbie$arrest7type <- arrests.type[7]
      abbie$arrest8type <- arrests.type[8]
      abbie$arrest9type <- arrests.type[9]
      abbie$arrest10type <- arrests.type[10]
      abbie$arrest11type <- arrests.type[11]
      abbie$aq1 = arrest_quarters[1]
      abbie$aq2 = arrest_quarters[2]
      abbie$aq3 = arrest_quarters[3]
      abbie$aq4 = arrest_quarters[4]
      abbie$aq5 = arrest_quarters[5]
      abbie$aq6 = arrest_quarters[6]
      abbie$aq7 = arrest_quarters[7]
      abbie$aq8 = arrest_quarters[8]
      abbie$aq9 = arrest_quarters[9]
      abbie$aq10 = arrest_quarters[10]
      abbie$aq11 = arrest_quarters[11]
    } else if(length(arrests.abbie) == 12){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest6 <- arrests.abbie[6]
      abbie$arrest7 <- arrests.abbie[7]
      abbie$arrest8 <- arrests.abbie[8]
      abbie$arrest9 <- arrests.abbie[9]
      abbie$arrest10 <- arrests.abbie[10]
      abbie$arrest11 <- arrests.abbie[11]
      abbie$arrest12 <- arrests.abbie[12]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest5type <- arrests.type[5]
      abbie$arrest6type <- arrests.type[6]
      abbie$arrest7type <- arrests.type[7]
      abbie$arrest8type <- arrests.type[8]
      abbie$arrest9type <- arrests.type[9]
      abbie$arrest10type <- arrests.type[10]
      abbie$arrest11type <- arrests.type[11]
      abbie$arrest12type <- arrests.type[12]
      abbie$aq1 = arrest_quarters[1]
      abbie$aq2 = arrest_quarters[2]
      abbie$aq3 = arrest_quarters[3]
      abbie$aq4 = arrest_quarters[4]
      abbie$aq5 = arrest_quarters[5]
      abbie$aq6 = arrest_quarters[6]
      abbie$aq7 = arrest_quarters[7]
      abbie$aq8 = arrest_quarters[8]
      abbie$aq9 = arrest_quarters[9]
      abbie$aq10 = arrest_quarters[10]
      abbie$aq11 = arrest_quarters[11]
      abbie$aq12 = arrest_quarters[12]
    }else if(length(arrests.abbie) == 13){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest6 <- arrests.abbie[6]
      abbie$arrest7 <- arrests.abbie[7]
      abbie$arrest8 <- arrests.abbie[8]
      abbie$arrest9 <- arrests.abbie[9]
      abbie$arrest10 <- arrests.abbie[10]
      abbie$arrest11 <- arrests.abbie[11]
      abbie$arrest12 <- arrests.abbie[12]
      abbie$arrest13 <- arrests.abbie[13]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest5type <- arrests.type[5]
      abbie$arrest6type <- arrests.type[6]
      abbie$arrest7type <- arrests.type[7]
      abbie$arrest8type <- arrests.type[8]
      abbie$arrest9type <- arrests.type[9]
      abbie$arrest10type <- arrests.type[10]
      abbie$arrest11type <- arrests.type[11]
      abbie$arrest12type <- arrests.type[12]
      abbie$arrest13type <- arrests.type[13]
      abbie$aq1 = arrest_quarters[1]
      abbie$aq2 = arrest_quarters[2]
      abbie$aq3 = arrest_quarters[3]
      abbie$aq4 = arrest_quarters[4]
      abbie$aq5 = arrest_quarters[5]
      abbie$aq6 = arrest_quarters[6]
      abbie$aq7 = arrest_quarters[7]
      abbie$aq8 = arrest_quarters[8]
      abbie$aq9 = arrest_quarters[9]
      abbie$aq10 = arrest_quarters[10]
      abbie$aq11 = arrest_quarters[11]
      abbie$aq12 = arrest_quarters[12]
      abbie$aq13 = arrest_quarters[13]
    }
    else if(length(arrests.abbie) == 14){
      abbie$arrest1 <- arrests.abbie[1]
      abbie$arrest2 <- arrests.abbie[2]
      abbie$arrest3 <- arrests.abbie[3]
      abbie$arrest4 <- arrests.abbie[4]
      abbie$arrest5 <- arrests.abbie[5]
      abbie$arrest6 <- arrests.abbie[6]
      abbie$arrest7 <- arrests.abbie[7]
      abbie$arrest8 <- arrests.abbie[8]
      abbie$arrest9 <- arrests.abbie[9]
      abbie$arrest10 <- arrests.abbie[10]
      abbie$arrest11 <- arrests.abbie[11]
      abbie$arrest12 <- arrests.abbie[12]
      abbie$arrest13 <- arrests.abbie[13]
      abbie$arrest14 <- arrests.abbie[14]
      abbie$arrest1type <- arrests.type[1]
      abbie$arrest2type <- arrests.type[2]
      abbie$arrest3type <- arrests.type[3]
      abbie$arrest4type <- arrests.type[4]
      abbie$arrest5type <- arrests.type[5]
      abbie$arrest6type <- arrests.type[6]
      abbie$arrest7type <- arrests.type[7]
      abbie$arrest8type <- arrests.type[8]
      abbie$arrest9type <- arrests.type[9]
      abbie$arrest10type <- arrests.type[10]
      abbie$arrest11type <- arrests.type[11]
      abbie$arrest12type <- arrests.type[12]
      abbie$arrest13type <- arrests.type[13]
      abbie$arrest14type <- arrests.type[14]
      abbie$aq1 = arrest_quarters[1]
      abbie$aq2 = arrest_quarters[2]
      abbie$aq3 = arrest_quarters[3]
      abbie$aq4 = arrest_quarters[4]
      abbie$aq5 = arrest_quarters[5]
      abbie$aq6 = arrest_quarters[6]
      abbie$aq7 = arrest_quarters[7]
      abbie$aq8 = arrest_quarters[8]
      abbie$aq9 = arrest_quarters[9]
      abbie$aq10 = arrest_quarters[10]
      abbie$aq11 = arrest_quarters[11]
      abbie$aq12 = arrest_quarters[12]
      abbie$aq13 = arrest_quarters[13]
      abbie$aq14 = arrest_quarters[14]
    }
  }
  
  #Ever arrested indicator variable
  abbie$ever.arrested <- ifelse(any(is.na(arrests.abbie)), 0, 1)
  #Which quarter were you arrested in calculation
  arrests = c(words$Arrest.Date)
  arrest.quarter.list = c()
  cq.dates = cq.dates2
  if(is.na(arrests[1])){
    quarters_achieved = quarters_achieved
  } else{
    for(j in 1:length(arrests)){
      arrest.quarter.min = max(which(arrests[j] > cq.dates))
      arrest.quarter.min = cq.dates.df[arrest.quarter.min + 1, 2]
      arrest.quarter.max = min(which(arrests[j] <  cq.dates)) - 1
      arrest.quarter.list = c(arrest.quarter.list, arrest.quarter.min)
    }
  }
  
  #Arrest matrix
  arrest.inter = data.frame(id = unique(words$id))
  arrest.inter$one = sum(arrest.quarter.list == 1)
  arrest.inter$two = sum(arrest.quarter.list == 2)
  arrest.inter$thr = sum(arrest.quarter.list == 3)
  arrest.inter$fou = sum(arrest.quarter.list == 4)
  arrest.inter$fiv = sum(arrest.quarter.list == 5)
  arrest.inter$six = sum(arrest.quarter.list == 6)
  arrest.inter$sev = sum(arrest.quarter.list == 7)
  arrest.inter$eig = sum(arrest.quarter.list == 8)
  arrest.inter$nin = sum(arrest.quarter.list == 9)
  
  arrest.matrix = rbind(arrest.matrix, arrest.inter)
  #Not sure if this will fix the issue where 2 potential quarters, but both were arrested in.
  duplicated_quarters = quarters_achieved[which(duplicated(quarters_achieved) & quarters_achieved %in% arrest.quarter.list)]
  quarters_achieved = quarters_achieved[!(quarters_achieved %in% arrest.quarter.list)]
  quarters_achieved = c(quarters_achieved, duplicated_quarters)
  
  abbie$pq1 <- ifelse(1 %in% quarters_achieved, sum(quarters_achieved == 1), 0)
  abbie$pq2 <- ifelse(2 %in% quarters_achieved, sum(quarters_achieved == 2), 0)
  abbie$pq3 <- ifelse(3 %in% quarters_achieved, sum(quarters_achieved == 3), 0)
  abbie$pq4 <- ifelse(4 %in% quarters_achieved, sum(quarters_achieved == 4), 0)
  abbie$pq5 <- ifelse(5 %in% quarters_achieved, sum(quarters_achieved == 5), 0)
  abbie$pq6 <- ifelse(6 %in% quarters_achieved, sum(quarters_achieved == 6), 0)
  abbie$pq7 <- ifelse(7 %in% quarters_achieved, sum(quarters_achieved == 7), 0)
  abbie$pq8 <- ifelse(8 %in% quarters_achieved, sum(quarters_achieved == 8), 0)
  abbie$pq9 <- ifelse(9 %in% quarters_achieved, sum(quarters_achieved == 9), 0)
  
  
  abbie[abbie$id == 3334613, 'cq5'] = 0
  abbie[abbie$id == 3334613, 'cq6'] = 1
  
  abbie$jan_march18 <- ifelse(abbie$cq1 != 0 & abbie$pq1 != 0, abbie$pq1,
                              ifelse(abbie$cq1 != 0 & abbie$pq1 == 0, 0, NA))
  abbie$apr_june18  <- ifelse(abbie$cq2 != 0 & abbie$pq2 != 0, abbie$pq2,
                              ifelse(abbie$cq2 != 0 & abbie$pq2 == 0, 0, NA))
  abbie$july_sep18  <- ifelse(abbie$cq3 != 0 & abbie$pq3 != 0, abbie$pq3,
                              ifelse(abbie$cq3 != 0 & abbie$pq3 == 0, 0, NA))
  abbie$oct_dec18   <- ifelse(abbie$cq4 != 0 & abbie$pq4 != 0, abbie$pq4,
                              ifelse(abbie$cq4 != 0 & abbie$pq4 == 0, 0, NA))
  abbie$jan_march19 <- ifelse(abbie$cq5 != 0 & abbie$pq5 != 0, abbie$pq5,
                              ifelse(abbie$cq5 != 0 & abbie$pq5 == 0, 0, NA))
  abbie$apr_june19 <- ifelse(abbie$cq6 != 0 & abbie$pq6 != 0, abbie$pq6,
                             ifelse(abbie$cq6 != 0 & abbie$pq6 == 0, 0, NA))
  abbie$july_sep19 <- ifelse(abbie$cq7 != 0 & abbie$pq7 != 0, abbie$pq7,
                             ifelse(abbie$cq7 != 0 & abbie$pq7 == 0, 0, NA))
  abbie$oct_dec19 <- ifelse(abbie$cq8 != 0 & abbie$pq8 != 0, abbie$pq8,
                            ifelse(abbie$cq8 != 0 & abbie$pq8 == 0, 0, NA))
  abbie$jan_mar20 <- ifelse(abbie$cq9 != 0 & abbie$pq9 != 0, abbie$pq9,
                            ifelse(abbie$cq9 != 0 & abbie$pq9 == 0, 0, NA))

  ncc_date = unique(words$ncc_date)
  abbie$ncc = ncc_date
  abbie.final <- rbind.fill(abbie.final, abbie)
  
}

abbie.final2 <- merge(abbie.final, pop[, c('id', 'X.6', 'Intake.Date')], by = 'id')
indice = which(names(abbie.final2) == 'X.6')
names(abbie.final2)[indice] = 'RandomGroup'
# write.csv(abbie.final, 'ucla_arrest_data_190127.csv', row.names = F)


pfs <- abbie.final2[abbie.final2$RandomGroup == 'Pay for Success',]               
pas <- abbie.final2[abbie.final2$RandomGroup == 'Probation as Usual', ]               

pfs <- pfs[!(pfs$Intake.Date == ' '), ]
pfs <- (pfs[as.Date(pfs$Intake.Date, format = '%m/%d/%Y') <= as.Date('03/31/2020', format = '%m/%d/%Y'),])



other <- pas              
```

## Data Collection

Individuals were recruited ________________. 
We analyze individuals for 6 observational periods of 90 days. We call these 90 day subsets quarters, and label them quarter 1, quarter 2, and so forth. Cohort 1 collection ended on 6/1/2019, and our observation for them continues through 10/1/20. The cohort 1 enrollment took in `r dim(abbie.final2)[1]` parolees, randomizing `r table(abbie.final2$RandomGroup)[1]` into the Pay for Success program. When we say "between groups", which we will refer to often, we mean between individuals in the Pay for Success program and those in the Control group. Due to NCC processes, `r table(abbie.final2$RandomGroup)[1] - dim(pfs)[1]` people were removed and `r dim(pfs)[1]` were analyzed from start to finish. The other `r table(abbie.final2$RandomGroup)[1] - dim(pfs)[1]` individuals were analyzed for __ of the __ potential quarters before being removed. 

## Demographics
The demographic variables were supposed to match up between the groups. If they did not, we would have to implement some proportion matching to equate the populations. Table 1 below shows no significant differences between the demographics of Pay for Success Group and the Control group.
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=T}
npfs = dim(pfs)[1]
nother = dim(other)[1]
pfs_age = paste0(round(mean(pfs$age), 1), ' (', round(sd(pfs$age), 1), ')')
other_age = paste0(round(mean(other$age), 1), ' (', round(sd(other$age), 1), ')')
pfs_black = table(pfs$race)[1]
pfs_race = data.frame(table(pfs$race))
pfs_gender = data.frame(table(pfs$gender))
pfs_risk.level = data.frame(table(pfs$risk.level))

other_race = data.frame(table(other$race))
other_gender = data.frame(table(other$gender))
other_risk.level = data.frame(table(other$risk.level))

pfs_race[,1] = as.character(pfs_race[,1])
pfs_race[2,1] = 'Other'
pfs_race[2,2] = '5'
pfs_race = pfs_race[1:4,]

other_race[,1] = as.character(other_race[,1])
other_race[2,1] = 'Other'
other_race[2,2] = '8'
other_race = other_race[1:4,]

M <- as.table(rbind(as.numeric(pfs_race[,2]), as.numeric(other_race[,2])))
race_p = chisq.test(M)$p.value

gender_p = prop.test(c(pfs_gender[2,2], other_gender[2,2]), c(sum(pfs_gender[,2]), sum(other_gender[,2])))$p.value

age_p = t.test(pfs$age, other$age)$p.value

M <- as.table(rbind(as.numeric(pfs_risk.level[,2]), as.numeric(other_risk.level[,2])))
risk_p = chisq.test(M)$p.value

demo_df = data.frame(variable = c('# of Sample Population Members', 'Age, Mean (SD)', 'Female/Male', 'Race', 'White', 'Hispanic', 'Black', 'Other', 'ORAS Risk Level', 'Low', 'Low/Moderate', 'Moderate', 'High', 'Very High'),
                     pfs = c(npfs, pfs_age, paste(pfs_gender[1,2], pfs_gender[2,2], sep = '/'), '', pfs_race[3,2], pfs_race[4,2], pfs_race[1,2], pfs_race[2,2], '', pfs_risk.level[3,2], pfs_risk.level[4,2], pfs_risk.level[5,2],
                             pfs_risk.level[2,2], pfs_risk.level[6,2]),
                     other = c(nother, other_age, paste(other_gender[1,2], other_gender[2,2], sep = '/'), '', other_race[3,2], other_race[4,2], other_race[1,2], other_race[2,2], '', other_risk.level[3,2], other_risk.level[4,2], other_risk.level[5,2],
                             other_risk.level[2,2], other_risk.level[6,2]),
                     pval = c('-', round(age_p, 4), round(gender_p, 4), round(race_p, 4), '-', '-', '-', '-', round(risk_p, 4),  '-', '-', '-', '-', '-'))
kable(demo_df)

```
The age of parolees enrolled ranged from `r min(pfs$age)` to `r max(pfs$age)`. Predominantly male and predominantly hispanic. The ORAS score follows a moderately normal distribution and again is not significantly different between groups.

## Criminal Justice History
Here is both a table and an accompanying graph of the arrests by population enrollment in both cohorts.
```{r, echo=FALSE, warning = F, cache = T, message=F}

pfs_pop = colSums(pfs[,c(20:28)])
pfs_clean = colSums(pfs[,c(31:39)])
pfs_a = pfs_pop - pfs_clean
pfs_a <- data.frame(index = c(1:9),
                    arrests = pfs_a)
pfs_pop = data.frame(index = c(1:9),
                  pop = pfs_pop)
# ggplot() + geom_line(aes(x = index, y = arrests), data = pfs_a) + geom_line(aes(x = index, y = pop), data = pfs_pop)
other_pop = colSums(other[,c(20:28)])
other_clean = colSums(other[,c(31:39)])
other_a = other_pop - other_clean
other_a <- data.frame(index = c(1:9),
                    arrests = other_a)
other_pop = data.frame(index = c(1:9),
                     pop = other_pop)

#Create dataframe for final numbers needed.
final <- data.frame(clean = c(),
                    potential = c())
for(i in 1:9){
  word.used.p = paste0('pq', i)
  word.used.c = paste0('cq', i)
  
  df = data.frame(clean = sum(pfs[[word.used.p]]),
                  potential =sum(pfs[[word.used.c]]))
  final = rbind(final, df)
}
#Create dataframe for final numbers needed.
final2 <- data.frame(clean = c(),
                    potential = c())
for(i in 1:9){
  word.used.p = paste0('pq', i)
  word.used.c = paste0('cq', i)
  
  df = data.frame(clean = sum(other[[word.used.p]]),
                  potential =sum(other[[word.used.c]]))
  final2 = rbind(final2, df)
}

final$group = 'pfs'
final2$group = 'other'
final$num.arrests = colSums(pfs[,c(50:58)], na.rm = T)
final2$num.arrests = colSums(other[,c(50:58)], na.rm = T)

people <- c()
people2 <- c()
for(i in 50:58){
  test = pfs[,c(i)]
  test = test[!is.na(test)]
  test = test[test!=0]
  people = c(people, length(test))
}

for(i in 50:58){
  test = other[,c(i)]
  test = test[!is.na(test)]
  test = test[test!=0]
  people2 = c(people2, length(test))
}
final$people = people
final2$people = people2


aq_names = paste0('aq', 1:9)
aq_names = which(names(pfs) %in% aq_names)
pfs$a1 = paste0(pfs$aq1, pfs$arrest1type)
pfs$a2 = paste0(pfs$aq2, pfs$arrest2type)
pfs$a3 = paste0(pfs$aq3, pfs$arrest3type)
pfs$a4 = paste0(pfs$aq4, pfs$arrest4type)
pfs$a5 = paste0(pfs$aq5, pfs$arrest5type)
pfs$a6 = paste0(pfs$aq6, pfs$arrest6type)
pfs$a7 = paste0(pfs$aq7, pfs$arrest7type)
pfs$a8 = paste0(pfs$aq8, pfs$arrest8type)
pfs$a9 = paste0(pfs$aq9, pfs$arrest9type)
pls = c()
for(i in 88:96){
  intermed = pfs[,i]
  pls = c(pls, intermed)
}

other$a1 = paste0(other$aq1, other$arrest1type)
other$a2 = paste0(other$aq2, other$arrest2type)
other$a3 = paste0(other$aq3, other$arrest3type)
other$a4 = paste0(other$aq4, other$arrest4type)
other$a5 = paste0(other$aq5, other$arrest5type)
other$a6 = paste0(other$aq6, other$arrest6type)
other$a7 = paste0(other$aq7, other$arrest7type)
other$a8 = paste0(other$aq8, other$arrest8type)
other$a9 = paste0(other$aq9, other$arrest9type)
pls2 = c()
for(i in 88:96){
  intermed = other[,i]
  pls2 = c(pls2, intermed)
}

pls = data.frame(table(pls))
pls2 = data.frame(table(pls2))
pls.f = pls[c(2,4,6,8,11,13,15,17,19),]
pls.m = pls[c(3,5,7,9,12,14,16,18,20),]

pls2.f = pls2[c(2,4,6,8,10,12,14,16,19),]
pls2.m = pls2[c(3,5,7,9,11,13,15,17,20),]

final$misdemeanor = pls.m[,2]
final$felony = pls.f[,2]
final2$misdemeanor = pls2.m[,2]
final2$felony = pls2.f[,2]

final3 = rbind(final, final2)

kable(final)
kable(final2)


ggplot() + geom_line(aes(x = index, y = arrests), data = other_a, linetype = 2) + geom_line(aes(x = index, y = pop), data = other_pop, linetype = 2)+ geom_line(aes(x = index, y = arrests), data = pfs_a) + geom_line(aes(x = index, y = pop), data = pfs_pop)
```
Difference in misdemeanors chi square

```{r, echo=FALSE, warning = F, cache = T, message=F}
chisq.test(final$m, final2$m)
```
Difference in felonies chi square
```{r, echo=FALSE, warning = F, cache = T, message=F}
chisq.test(final$f, final2$f)
```
## Stratification Analysis - Gender, Race, and ORAS Risk Level

### Broken down by gender

```{r, echo=FALSE, warning = F, cache = T, message=F}

# rowSums(table(pfs$gender, pfs$num.arrests)[,-1])
# rowSums(table(other$gender, other$num.arrests)[,-1])
gender_df = data.frame(gender = c('Female', 'Male'), 
                     pfs = c(17, 82),
                     other = c(23,99))
M <- as.table(rbind(gender_df[,2], gender_df[,3]))

gender_df$pval = c(round(chisq.test(M)$p.value, 4), '-')
kable(gender_df)

```

### Broken down by race
Ventura county is predominantly a hispanic community.
```{r, echo=FALSE, warning = F, cache = T, message=F}
# 
# rowSums(table(pfs$race, pfs$num.arrests)[,-1])
# rowSums(table(other$race, other$num.arrests)[,-1])
race_df = data.frame(race = c('Hispanic', 'White', 'Black', 'Other'), 
                     pfs = c(55,38,4,2),
                     other = c(77,31,10,4))
M <- as.table(rbind(race_df[,2], race_df[,3]))

race_df$pval = c(round(chisq.test(M)$p.value, 4), '-', '-', '-')
kable(race_df)

```

### Broken down by ORAS Risk Level
We further analyze the arrest rates between groups by looking at the stratification of arrests by ORAS risk score. We see both the unique number of individuals being rearrested and the total number of arrests between groups is not signficiantly different. 

```{r, echo=FALSE, warning = F, cache = T, message=F}

# rowSums(table(pfs$risk.level, pfs$num.arrests)[,-1])
# rowSums(table(other$risk.level, other$num.arrests)[,-1])
risk_df = data.frame(risk.level = c('Low', 'Low/Moderate', 'Moderate', 'High', 'Very High'), 
                     pfs = c(7,5,51,33,3),
                     other = c(8,7,54,45,8))
M <- as.table(rbind(risk_df[,2], risk_df[,3]))

risk_df$pval = c(round(chisq.test(M)$p.value, 4), '-', '-', '-', '-')
kable(risk_df)

```




## Services Received
The question is, out of those who were randomized to be in our RCT, were there differences between those arrested and those not arrested? People were offered difference certives or cognitive behavioral therapy. These included case management, MRT, triple P, seek safety, job readiness, and other CBT.
```{r, echo=FALSE, warning = F, cache = T, message=F}
setwd('C:/Users/Mitchell Schepps/Desktop/nena')
supplemental = read.csv('supplemental_new.csv')

services = data.frame(services = c('Any CBT','Case Management', 'MRT', "Triple P", "Seek Safety", 'Job Readiness', 'Other CBT'))
services$prop = 0
for(i in 7:12){
  services$prop[i-6] = prop.table(table(supplemental[,i], useNA = 'always'))[2]
}



```

## Differences within service members between those arrested and not
```{r, echo=FALSE, warning = F, cache = T, message=F}

names(supplemental)[1] = 'id'
bigone = merge(pfs, supplemental, by = 'id')
e.a = bigone[bigone$ever.arrested == 1,]
n.a = bigone[bigone$ever.arrested == 0,]
services2 = data.frame(services = c('Case Management', 'MRT', "Triple P", "Seek Safety", 'Job Readiness', 'Other CBT', names(bigone)[130:146]))
services2$never = 0
services2$ever = 0
for(i in 102:107){
    services2$never[i-101] = prop.table(table(n.a[,i], useNA = 'always'))[2]
    services2$ever[i-101]  = prop.table(table(e.a[,i], useNA = 'always'))[2]
}
for(i in 130:146){
  n.a[,i] = ifelse(n.a[,i] == 'NULL', NA, n.a[,i])
  n.a[,i] = ifelse(n.a[,i] == 99, NA, n.a[,i])
  e.a[,i] = ifelse(e.a[,i] == 'NULL', NA, e.a[,i])
  e.a[,i] = ifelse(e.a[,i] == 99, NA, e.a[,i])
  services2$never[i-123] = mean(n.a[,i], na.rm = T)
  services2$ever[i-123] = mean(e.a[,i], na.rm = T)
}
services2[1,2] = 1
services2[1,3] = 1
services2$pval = '-'
services2$pval[1] = 1.000
# chisq.test(rbind(services2$never, services2$ever))
kable(services2[1:5,])
kable(services2[6:23,])

```
We see that of those not arrested, those individuals are using more of the services. It appears that services lessens the possibility of receiving services. Further, in the SSM calculation, each category had a higher mean yet not a significant difference

## Summary

## Cohort 2 Preview

## COVID Analysis
With the genuity of the COVID-19 pandemic, we saw dramatic reductions of in-person hearings. Some hearings were moved to online. In fact, police officers were told to arrest less on the minor offenses. We used a date of March 21, 2020 as the cut-off between COVID-19 policy enaction. This as of the date of the publication, only affected two months of Cohort 1 and up to 6 total for them. As of today, the policies remain the same in Ventura county. Quarantine has not been lifted. We tested to see if the arrest rates for both groups remained similar or experienced a similar drop-off after the cutoff.